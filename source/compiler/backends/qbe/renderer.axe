/// Author: Navid Momtahen (C) 2026
/// License: GPL-3.0
/// 
/// QBE IR backend renderer for Axe compiler.

use ../../gstate;
use ../../structs (ASTNode);
use std.lists     (StringList);
use std.string;
use std.io;
use std.maps;
use std.arena;

/// Global QBE IR string builder
mut g_qbe_sb: StringBuilder;

/// Track QBE register counter  
mut g_qbe_register_counter: i32;

/// Track variable to register mappings
mut g_qbe_var_registers: StringStringMap;

/// Track variable types
mut g_qbe_var_types: StringStringMap;

/// Track model definitions
mut g_qbe_model_definitions: StringStringMap;

/// Track model field offsets
mut g_qbe_model_field_offsets: StringIntMap;

/// Track string literals for data section
mut g_qbe_string_counter: i32 = 0;

/// Track the actual string literals
mut g_qbe_string_literals: StringStringMap;

/// Track overload mappings: overload_name -> (type -> target_function)
mut g_qbe_overloads: StringStringMap;

/// Track extern function mappings: function_name -> symbol_name
mut g_qbe_externs: StringStringMap;

/// Track if QBE renderer is initialized
mut g_qbe_initialized: bool = false;

/// Arena for QBE renderer memory management
mut g_qbe_arena: Arena;

/// Initialize the QBE renderer
pub def initialize_qbe_renderer() {
    g_qbe_arena = Arena.create(1024 * 1024);
    g_qbe_var_registers = deref(StringStringMap.create(addr(g_qbe_arena), 128));
    g_qbe_var_types = deref(StringStringMap.create(addr(g_qbe_arena), 128));
    g_qbe_model_definitions = deref(StringStringMap.create(addr(g_qbe_arena), 128));
    g_qbe_model_field_offsets = deref(StringIntMap.create(addr(g_qbe_arena), 256));
    g_qbe_string_literals = deref(StringStringMap.create(addr(g_qbe_arena), 64));
    g_qbe_overloads = deref(StringStringMap.create(addr(g_qbe_arena), 64));
    g_qbe_externs = deref(StringStringMap.create(addr(g_qbe_arena), 64));
    g_qbe_register_counter = 1;
    g_qbe_string_counter = 0;
    g_qbe_initialized = true;
}

/// Get next register name
def next_qbe_register(): string {
    val reg: string = concat(str("%r"), i32_to_string(g_qbe_register_counter));
    g_qbe_register_counter++;
    return reg;
}

/// Generate QBE IR for an AST node
pub def generate_qbe(ast: ref ASTNode): string {
    if ast == nil {
        return str("# Empty AST\n");
    }
    
    g_qbe_sb = StringBuilder.init(4096);
    g_qbe_register_counter = 1;
    
    val code: string = render_qbe_ast_node(ast);
    mut fixed_code: string = replace_all(code, str("()("), str("("));
    fixed_code = replace_all(fixed_code, str("()()"), str("()"));
    
    return fixed_code;
}

/// Render any AST node based on its type
def render_qbe_ast_node(ast: ref ASTNode): string {
    if ast == nil {
        return str("");
    }
    
    val node_type: string = ast.node_type;
    if str_len(node_type) == 0 {
        return str("");
    }
    
    if equals_c(node_type, "Program") {
        return render_qbe_program(ast);
    } elif equals_c(node_type, "Function") {
        return render_qbe_function(ast);
    } elif equals_c(node_type, "Return") {
        return render_qbe_return(ast);
    } elif equals_c(node_type, "Declaration") {
        return render_qbe_declaration(ast);
    } elif equals_c(node_type, "Assignment") {
        return render_qbe_assignment(ast);
    } elif equals_c(node_type, "If") {
        return render_qbe_if(ast);
    } elif equals_c(node_type, "Loop") {
        return render_qbe_loop(ast);
    } elif equals_c(node_type, "Print") {
        return render_qbe_print(ast);
    } elif equals_c(node_type, "Put") {
        return render_qbe_print(ast);
    } elif equals_c(node_type, "Model") {
        return render_qbe_model(ast);
    } elif equals_c(node_type, "FunctionCall") {
        return render_qbe_function_call(ast);
    } elif equals_c(node_type, "Overload") {
        return render_qbe_overload(ast);
    } elif equals_c(node_type, "Extern") {
        return render_qbe_extern(ast);
    } elif equals_c(node_type, "Test") {
        return render_qbe_test(ast);
    } elif equals_c(node_type, "Unsafe") {
        return render_qbe_unsafe(ast);
    } elif equals_c(node_type, "MemberAccess") {
        return render_qbe_member_access(ast);
    }
    
    return str("");
}

/// Render program node
def render_qbe_program(ast: ref ASTNode): string {
    if ast.children == nil {
        return str("");
    }
    
    val children: ref list(ASTNode) = ast.children;
    val child_count: i32 = len(deref(children));
    mut i: i32 = 0;
    
    loop {
        if i >= child_count {
            break;
        }
        val child_code: string = render_qbe_ast_node(addr(children.data[i]));
        StringBuilder.append(addr(g_qbe_sb), child_code);
        i++;
    }
    
    mut final_sb: StringBuilder = StringBuilder.init(1024);
    val keys: ref StringList = g_qbe_string_literals.keys;
    mut j: i32 = 0;
    
    loop {
        if j >= keys.len {
            break;
        }
        val message: string = keys.data[j];
        val str_name: string = StringStringMap.get(addr(g_qbe_string_literals), message);
        
        StringBuilder.append(addr(final_sb), str("data $"));
        StringBuilder.append(addr(final_sb), str_name);
        StringBuilder.append(addr(final_sb), str(" = { b \""));
        StringBuilder.append(addr(final_sb), message);
        StringBuilder.append(addr(final_sb), str("\\0\" }\n"));

        j++;
    }
    
    if keys.len > 0 {
        StringBuilder.append(addr(final_sb), str("\n"));
    }
    
    StringBuilder.append(addr(final_sb), StringBuilder.to_string(addr(g_qbe_sb)));
    
    return StringBuilder.to_string(addr(final_sb));
}

/// Render function definition
def render_qbe_function(ast: ref ASTNode): string {
    val func_name: string = ast.data.function.name;
    val return_type: string = ast.data.function.return_type;
    
    if ast.children == nil {
        return str("");
    }
    
    val children: ref list(ASTNode) = ast.children;
    val child_count: i32 = len(deref(children));
    
    if child_count == 0 {
        return str("");
    }
    
    mut has_meaningful_code: bool = false;
    mut i: i32 = 0;
    loop {
        if i >= child_count {
            break;
        }
        val child: ref ASTNode = addr(children.data[i]);
        if equals_c(child.node_type, "Return") or 
           equals_c(child.node_type, "Declaration") or
           equals_c(child.node_type, "FunctionCall") or
           equals_c(child.node_type, "Print") or
           equals_c(child.node_type, "If") or
           equals_c(child.node_type, "Loop") {
            has_meaningful_code = true;
            break;
        }
        i++;
    }
    
    if !has_meaningful_code {
        return str("");
    }
    
    mut sb: StringBuilder = StringBuilder.init(512);
    
    StringBuilder.append(addr(sb), str("export function w $"));
    StringBuilder.append(addr(sb), func_name);
    StringBuilder.append(addr(sb), str("() {\n"));
    StringBuilder.append(addr(sb), str("@start\n"));
    
    if str_contains(func_name, str("string")) or str_contains(func_name, str("str_")) {
        val param_reg: string = next_qbe_register();
        StringBuilder.append(addr(sb), str("    "));
        StringBuilder.append(addr(sb), param_reg);
        StringBuilder.append(addr(sb), str(" =l alloc8 8\n"));
        StringStringMap.set(addr(g_qbe_var_registers), addr(g_qbe_arena), str("s"), param_reg);
    }
    
    val body_code: string = render_qbe_function_body(children);
    StringBuilder.append(addr(sb), body_code);
    
    StringBuilder.append(addr(sb), str("}\n\n"));
    return StringBuilder.to_string(addr(sb));
}

/// Render function body with proper return handling
def render_qbe_function_body(children: ref list(ASTNode)): string {
    val child_count: i32 = len(deref(children));
    mut sb: StringBuilder = StringBuilder.init(512);
    mut has_return: bool = false;
    mut i: i32 = 0;
    
    loop {
        if i >= child_count or has_return {
            break;
        }
        
        val child: ref ASTNode = addr(children.data[i]);
        val child_code: string = render_qbe_ast_node(child);
        
        if str_contains(child_code, str("ret ")) {
            StringBuilder.append(addr(sb), child_code);
            has_return = true;
        } elif equals_c(child.node_type, "If") and str_contains(child_code, str("@after_")) and str_contains(child_code, str("ret 0")) {
            StringBuilder.append(addr(sb), child_code);
            has_return = true;
        } elif equals_c(child.node_type, "Loop") and str_contains(child_code, str("jmp @loop_")) {
            StringBuilder.append(addr(sb), child_code);
            has_return = true;
        } else {
            StringBuilder.append(addr(sb), child_code);
        }
        
        i++;
    }
    
    if !has_return {
        StringBuilder.append(addr(sb), str("    ret 0\n"));
    }
    
    return StringBuilder.to_string(addr(sb));
}

/// Render declaration node
def render_qbe_declaration(ast: ref ASTNode): string {
    val name: string = ast.data.declaration.name;
    val type_name: string = ast.data.declaration.type_name;
    val initializer: string = ast.data.declaration.initializer;
    val reg: string = next_qbe_register();

    StringStringMap.set(addr(g_qbe_var_registers), addr(g_qbe_arena), name, reg);
    StringStringMap.set(addr(g_qbe_var_types), addr(g_qbe_arena), name, type_name);
    
    mut sb: StringBuilder = StringBuilder.init(128);

    if StringStringMap.contains(addr(g_qbe_model_definitions), type_name) {
        StringBuilder.append(addr(sb), str("    "));
        StringBuilder.append(addr(sb), reg);
        StringBuilder.append(addr(sb), str(" =l alloc8 8\n"));
        
        if str_len(initializer) > 0 and str_contains(initializer, str("{ }")) {
            StringBuilder.append(addr(sb), str("    storew 0, "));
            StringBuilder.append(addr(sb), reg);
            StringBuilder.append(addr(sb), str("\n"));
            val offset_reg: string = next_qbe_register();
            StringBuilder.append(addr(sb), str("    "));
            StringBuilder.append(addr(sb), offset_reg);
            StringBuilder.append(addr(sb), str(" =l add "));
            StringBuilder.append(addr(sb), reg);
            StringBuilder.append(addr(sb), str(", 4\n"));
            StringBuilder.append(addr(sb), str("    storew 0, "));
            StringBuilder.append(addr(sb), offset_reg);
            StringBuilder.append(addr(sb), str("\n"));
        } else {
            StringBuilder.append(addr(sb), str("    storew 0, "));
            StringBuilder.append(addr(sb), reg);
            StringBuilder.append(addr(sb), str("\n"));
            val offset_reg: string = next_qbe_register();
            StringBuilder.append(addr(sb), str("    "));
            StringBuilder.append(addr(sb), offset_reg);
            StringBuilder.append(addr(sb), str(" =l add "));
            StringBuilder.append(addr(sb), reg);
            StringBuilder.append(addr(sb), str(", 4\n"));
            StringBuilder.append(addr(sb), str("    storew 0, "));
            StringBuilder.append(addr(sb), offset_reg);
            StringBuilder.append(addr(sb), str("\n"));
        }
    } else {
        StringBuilder.append(addr(sb), str("    "));
        StringBuilder.append(addr(sb), reg);
        StringBuilder.append(addr(sb), str(" =l alloc4 4\n"));
        
        if str_len(initializer) > 0 {
            if contains_function_call(initializer) {
                val temp_reg: string = next_qbe_register();
                val call_code: string = render_function_call_expression(initializer, temp_reg);
                StringBuilder.append(addr(sb), call_code);
                StringBuilder.append(addr(sb), str("    storew "));
                StringBuilder.append(addr(sb), temp_reg);
                StringBuilder.append(addr(sb), str(", "));
                StringBuilder.append(addr(sb), reg);
                StringBuilder.append(addr(sb), str("\n"));
            } elif str_contains(initializer, str(".")) and !is_float_literal(initializer) {
                val dot_pos: i32 = find_substr(initializer, str("."));
                if dot_pos > 0 {
                    val object_name: string = substring_se(initializer, 0, dot_pos);
                    val member_name: string = substring_se(
                        initializer, dot_pos + 1,
                        cast[i32](str_len(initializer))
                    );
                    
                    if StringStringMap.contains(addr(g_qbe_var_registers), object_name) {
                        val object_reg: string = StringStringMap.get(
                            addr(g_qbe_var_registers),
                            object_name
                        );
                        val temp_reg: string = next_qbe_register();
                        
                        if equals_c(member_name, "len") {
                            val addr_reg: string = next_qbe_register();
                            StringBuilder.append(addr(sb), str("    "));
                            StringBuilder.append(addr(sb), addr_reg);
                            StringBuilder.append(addr(sb), str(" =l add "));
                            StringBuilder.append(addr(sb), object_reg);
                            StringBuilder.append(addr(sb), str(", 8\n"));
                            StringBuilder.append(addr(sb), str("    "));
                            StringBuilder.append(addr(sb), temp_reg);
                            StringBuilder.append(addr(sb), str(" =w loadw "));
                            StringBuilder.append(addr(sb), addr_reg);
                            StringBuilder.append(addr(sb), str("\n"));
                        } elif equals_c(member_name, "cap") {
                            val addr_reg: string = next_qbe_register();
                            StringBuilder.append(addr(sb), str("    "));
                            StringBuilder.append(addr(sb), addr_reg);
                            StringBuilder.append(addr(sb), str(" =l add "));
                            StringBuilder.append(addr(sb), object_reg);
                            StringBuilder.append(addr(sb), str(", 16\n"));
                            StringBuilder.append(addr(sb), str("    "));
                            StringBuilder.append(addr(sb), temp_reg);
                            StringBuilder.append(addr(sb), str(" =w loadw "));
                            StringBuilder.append(addr(sb), addr_reg);
                            StringBuilder.append(addr(sb), str("\n"));
                        } elif equals_c(member_name, "data") {
                            StringBuilder.append(addr(sb), str("    "));
                            StringBuilder.append(addr(sb), temp_reg);
                            StringBuilder.append(addr(sb), str(" =w loadw "));
                            StringBuilder.append(addr(sb), object_reg);
                            StringBuilder.append(addr(sb), str("\n"));
                        } else {
                            StringBuilder.append(addr(sb), str("    storew 0, "));
                            StringBuilder.append(addr(sb), reg);
                            StringBuilder.append(addr(sb), str("\n"));
                            return StringBuilder.to_string(addr(sb));
                        }
                        
                        StringBuilder.append(addr(sb), str("    storew "));
                        StringBuilder.append(addr(sb), temp_reg);
                        StringBuilder.append(addr(sb), str(", "));
                        StringBuilder.append(addr(sb), reg);
                        StringBuilder.append(addr(sb), str("\n"));
                    } else {
                        mut processed_init: string = process_c_function_calls(initializer);
                        processed_init = fix_float_literals(processed_init);
                        StringBuilder.append(addr(sb), str("    storew "));
                        StringBuilder.append(addr(sb), processed_init);
                        StringBuilder.append(addr(sb), str(", "));
                        StringBuilder.append(addr(sb), reg);
                        StringBuilder.append(addr(sb), str("\n"));
                    }
                } else {
                    mut processed_init: string = process_c_function_calls(initializer);
                    processed_init = fix_float_literals(processed_init);
                    StringBuilder.append(addr(sb), str("    storew "));
                    StringBuilder.append(addr(sb), processed_init);
                    StringBuilder.append(addr(sb), str(", "));
                    StringBuilder.append(addr(sb), reg);
                    StringBuilder.append(addr(sb), str("\n"));
                }
            } else {
                mut processed_init: string = process_c_function_calls(initializer);
                processed_init = fix_float_literals(processed_init);
                StringBuilder.append(addr(sb), str("    storew "));
                StringBuilder.append(addr(sb), processed_init);
                StringBuilder.append(addr(sb), str(", "));
                StringBuilder.append(addr(sb), reg);
                StringBuilder.append(addr(sb), str("\n"));
            }
        } else {
            StringBuilder.append(addr(sb), str("    storew 0, "));
            StringBuilder.append(addr(sb), reg);
            StringBuilder.append(addr(sb), str("\n"));
        }
    }
    
    return StringBuilder.to_string(addr(sb));
}

/// Render print node
def render_qbe_print(ast: ref ASTNode): string {
    val messages_ref: ref list(string) = ast.data.print.messages;
    val flags_ref: ref list(bool) = ast.data.print.is_expressions;

    if messages_ref == nil or flags_ref == nil {
        return str("");
    }

    val messages: list(string) = deref(messages_ref);
    val flags: list(bool) = deref(flags_ref);

    if len(messages) == 0 {
        return str("");
    }

    mut sb: StringBuilder = StringBuilder.init(256);
    
    if len(messages) == 1 and len(flags) == 1 and !flags.data[0] {
        val message: string = messages.data[0];
        
        mut str_name: string;
        if StringStringMap.contains(addr(g_qbe_string_literals), message) {
            str_name = StringStringMap.get(addr(g_qbe_string_literals), message);
        } else {
            str_name = concat(str("str_"), i32_to_string(g_qbe_string_counter));
            g_qbe_string_counter++;
            StringStringMap.set(
                addr(g_qbe_string_literals),
                addr(g_qbe_arena),
                message,
                str_name
            );
        }
        
        StringBuilder.append(addr(sb), str("    call $printf(l $"));
        StringBuilder.append(addr(sb), str_name);
        StringBuilder.append(addr(sb), str(")\n"));
        return StringBuilder.to_string(addr(sb));
    }
    
    return StringBuilder.to_string(addr(sb));
}

/// Render return statement
def render_qbe_return(ast: ref ASTNode): string {
    val expression: string = strip(ast.data.return_node.expression);
    
    mut sb: StringBuilder = StringBuilder.init(128);
    if str_len(expression) > 0 {
        if StringStringMap.contains(addr(g_qbe_var_registers), expression) {
            val reg: string = StringStringMap.get(addr(g_qbe_var_registers), expression);
            val load_reg: string = next_qbe_register();
            StringBuilder.append(addr(sb), str("    "));
            StringBuilder.append(addr(sb), load_reg);
            StringBuilder.append(addr(sb), str(" =w loadw "));
            StringBuilder.append(addr(sb), reg);
            StringBuilder.append(addr(sb), str("\n"));
            StringBuilder.append(addr(sb), str("    ret "));
            StringBuilder.append(addr(sb), load_reg);
            StringBuilder.append(addr(sb), str("\n"));
        } elif contains_function_call(expression) {
            val temp_reg: string = next_qbe_register();
            val call_code: string = render_function_call_expression(expression, temp_reg);
            StringBuilder.append(addr(sb), call_code);
            StringBuilder.append(addr(sb), str("    ret "));
            StringBuilder.append(addr(sb), temp_reg);
            StringBuilder.append(addr(sb), str("\n"));
        } elif str_contains(expression, str(".")) {
            val dot_pos: i32 = find_substr(expression, str("."));
            if dot_pos > 0 {
                val object_name: string = substring_se(expression, 0, dot_pos);
                val member_name: string = substring_se(
                    expression,
                    dot_pos + 1,
                    cast[i32](str_len(expression))
                );
                
                if StringStringMap.contains(addr(g_qbe_var_registers), object_name) {
                    val object_reg: string = StringStringMap.get(addr(g_qbe_var_registers), object_name);
                    val temp_reg: string = next_qbe_register();
                    
                    if equals_c(member_name, "len") {
                        StringBuilder.append(addr(sb), str("    "));
                        StringBuilder.append(addr(sb), temp_reg);
                        StringBuilder.append(addr(sb), str(" =w loadw "));
                        StringBuilder.append(addr(sb), object_reg);
                        StringBuilder.append(addr(sb), str(" + 8\n"));
                        StringBuilder.append(addr(sb), str("    ret "));
                        StringBuilder.append(addr(sb), temp_reg);
                        StringBuilder.append(addr(sb), str("\n"));
                    } elif equals_c(member_name, "cap") {
                        StringBuilder.append(addr(sb), str("    "));
                        StringBuilder.append(addr(sb), temp_reg);
                        StringBuilder.append(addr(sb), str(" =w loadw "));
                        StringBuilder.append(addr(sb), object_reg);
                        StringBuilder.append(addr(sb), str(" + 16\n"));
                        StringBuilder.append(addr(sb), str("    ret "));
                        StringBuilder.append(addr(sb), temp_reg);
                        StringBuilder.append(addr(sb), str("\n"));
                    } else {
                        StringBuilder.append(addr(sb), str("    ret 0\n"));
                    }
                } else {
                    StringBuilder.append(addr(sb), str("    ret 0\n"));
                }
            } else {
                StringBuilder.append(addr(sb), str("    ret 0\n"));
            }
        } else {
            mut processed_expr: string = process_c_function_calls(expression);
            processed_expr = fix_float_literals(processed_expr);
            StringBuilder.append(addr(sb), str("    ret "));
            StringBuilder.append(addr(sb), processed_expr);
            StringBuilder.append(addr(sb), str("\n"));
        }
    } else {
        StringBuilder.append(addr(sb), str("    ret 0\n"));
    }
    return StringBuilder.to_string(addr(sb));
}

/// Render model definition
def render_qbe_model(ast: ref ASTNode): string {
    val model_name: string = ast.data.model_node.name;
    val field_names_ref: ref list(string) = ast.data.model_node.field_names;
    val field_types_ref: ref list(string) = ast.data.model_node.field_types;

    if field_names_ref == nil or field_types_ref == nil {
        return str("");
    }

    val field_names: list(string) = deref(field_names_ref);
    val field_types: list(string) = deref(field_types_ref);
    val field_count: i32 = len(field_names);

    if field_count != len(field_types) {
        return str("");
    }

    StringStringMap.set(
        addr(g_qbe_model_definitions),
        addr(g_qbe_arena),
        model_name,
        str("defined")
    );

    mut i: i32 = 0;
    loop {
        if i >= field_count {
            break;
        }
        val field_key: string = concat(concat(model_name, str(".")), field_names.data[i]);
        StringIntMap.set(addr(g_qbe_model_field_offsets), addr(g_qbe_arena), field_key, i * 4);
        i++;
    }

    return str("");
}

/// Render function call
def render_qbe_function_call(ast: ref ASTNode): string {
    val func_name: string = ast.data.func_call.function_name;
    val args: ref list(string) = ast.data.func_call.args;
    mut resolved_func_name: string = func_name;
    
    if has_prefix(func_name, str("C.")) {
        resolved_func_name = substr(func_name, 2, str_len(func_name) - 2);
    } elif StringStringMap.contains(addr(g_qbe_externs), func_name) {
        resolved_func_name = StringStringMap.get(addr(g_qbe_externs), func_name);
    } else {
        if args != nil and len(deref(args)) > 0 {
            val first_arg: string = args.data[0];
            if StringStringMap.contains(addr(g_qbe_var_types), first_arg) {
                val arg_type: string = StringStringMap.get(addr(g_qbe_var_types), first_arg);
                val overload_key: string = concat(concat(func_name, str(":")), arg_type);
                if StringStringMap.contains(addr(g_qbe_overloads), overload_key) {
                    resolved_func_name = StringStringMap.get(addr(g_qbe_overloads), overload_key);
                    if !str_contains(resolved_func_name, str("__")) {
                        resolved_func_name = concat(str("test_overload__"), resolved_func_name);
                    }
                }
            }
        }
    }
    
    mut sb: StringBuilder = StringBuilder.init(128);
    StringBuilder.append(addr(sb), str("    call $"));
    StringBuilder.append(addr(sb), resolved_func_name);
    StringBuilder.append(addr(sb), str("()\n"));
    
    return StringBuilder.to_string(addr(sb));
}

/// Render overload definition
def render_qbe_overload(ast: ref ASTNode): string {
    val overload_name: string = ast.data.overload_node.name;
    val type_names_ref: ref list(string) = ast.data.overload_node.type_names;
    val target_funcs_ref: ref list(string) = ast.data.overload_node.target_functions;
    
    if type_names_ref == nil or target_funcs_ref == nil {
        return str("");
    }
    
    val type_names: list(string) = deref(type_names_ref);
    val target_funcs: list(string) = deref(target_funcs_ref);
    val count: i32 = len(type_names);
    
    if count != len(target_funcs) {
        return str("");
    }
    
    mut i: i32 = 0;
    loop {
        if i >= count {
            break;
        }

        val type_name: string = type_names.data[i];
        val target_func: string = target_funcs.data[i];      
        val overload_key1: string = concat(concat(overload_name, str(":")), type_name);
        val overload_key2: string = concat(concat(str("print"), str(":")), type_name);
        
        StringStringMap.set(addr(g_qbe_overloads), addr(g_qbe_arena), overload_key1, target_func);
        StringStringMap.set(addr(g_qbe_overloads), addr(g_qbe_arena), overload_key2, target_func);
        i++;
    }
    
    return str("");
}

/// Render extern definition
def render_qbe_extern(ast: ref ASTNode): string {
    val func_name: string = ast.data.extern_node.function_name;
    val symbol: string = ast.data.extern_node.symbol;
    
    mut extern_symbol: string;
    if str_len(symbol) > 0 {
        extern_symbol = symbol;
    } else {
        extern_symbol = func_name;
    }
    StringStringMap.set(addr(g_qbe_externs), addr(g_qbe_arena), func_name, extern_symbol);
    
    return str("");
}

/// Render test block
def render_qbe_test(ast: ref ASTNode): string {
    mut sb: StringBuilder = StringBuilder.init(512);
    
    StringBuilder.append(addr(sb), str("export function w $main() {\n"));
    StringBuilder.append(addr(sb), str("@start\n"));
    
    if ast.children != nil {
        val children: ref list(ASTNode) = ast.children;
        val child_count: i32 = len(deref(children));
        mut i: i32 = 0;
        
        loop {
            if i >= child_count {
                break;
            }
            val child_code: string = render_qbe_ast_node(addr(children.data[i]));
            StringBuilder.append(addr(sb), child_code);
            i++;
        }
    }
    
    StringBuilder.append(addr(sb), str("    ret 0\n"));
    StringBuilder.append(addr(sb), str("}\n\n"));
    
    return StringBuilder.to_string(addr(sb));
}

/// Render unsafe block
def render_qbe_unsafe(ast: ref ASTNode): string {
    if ast.data.unsafe_node.body == nil {
        return str("");
    }
    
    val body: ref list(ASTNode) = ast.data.unsafe_node.body;
    val body_count: i32 = len(deref(body));
    mut sb: StringBuilder = StringBuilder.init(256);
    
    mut i: i32 = 0;
    loop {
        if i >= body_count {
            break;
        }
        val child_code: string = render_qbe_ast_node(addr(body.data[i]));
        StringBuilder.append(addr(sb), child_code);
        i++;
    }
    
    return StringBuilder.to_string(addr(sb));
}

/// Resolve member access in expressions (simplified version)
def resolve_member_access(expr: string): string {
    if !str_contains(expr, str(".")) {
        return expr;
    }
    
    val dot_pos: i32 = find_substr(expr, str("."));
    if dot_pos <= 0 {
        return expr;
    }
    
    val object_name: string = substring_se(expr, 0, dot_pos);
    val member_name: string = substring_se(expr, dot_pos + 1, cast[i32](str_len(expr)));
    
    if !StringStringMap.contains(addr(g_qbe_var_registers), object_name) {
        return expr;
    }
    
    val object_reg: string = StringStringMap.get(addr(g_qbe_var_registers), object_name);
    
    return object_reg;
}

/// Process member access and generate load instructions if needed
def process_member_access_expression(expr: string): string {
    if !str_contains(expr, str(".")) {
        return expr;
    }
    
    val dot_pos: i32 = find_substr(expr, str("."));
    if dot_pos <= 0 {
        return expr;
    }
    
    val object_name: string = substring_se(expr, 0, dot_pos);
    val member_name: string = substring_se(expr, dot_pos + 1, cast[i32](str_len(expr)));
    
    if !StringStringMap.contains(addr(g_qbe_var_registers), object_name) {
        return expr;
    }
    
    val object_reg: string = StringStringMap.get(addr(g_qbe_var_registers), object_name);
    val temp_reg: string = next_qbe_register();
    
    mut sb: StringBuilder = StringBuilder.init(128);
    
    if equals_c(member_name, "len") {
        val addr_reg: string = next_qbe_register();
        StringBuilder.append(addr(sb), str("    "));
        StringBuilder.append(addr(sb), addr_reg);
        StringBuilder.append(addr(sb), str(" =l add "));
        StringBuilder.append(addr(sb), object_reg);
        StringBuilder.append(addr(sb), str(", 8\n"));
        StringBuilder.append(addr(sb), str("    "));
        StringBuilder.append(addr(sb), temp_reg);
        StringBuilder.append(addr(sb), str(" =w loadw "));
        StringBuilder.append(addr(sb), addr_reg);
        StringBuilder.append(addr(sb), str("\n"));
    } elif equals_c(member_name, "cap") {
        val addr_reg: string = next_qbe_register();
        StringBuilder.append(addr(sb), str("    "));
        StringBuilder.append(addr(sb), addr_reg);
        StringBuilder.append(addr(sb), str(" =l add "));
        StringBuilder.append(addr(sb), object_reg);
        StringBuilder.append(addr(sb), str(", 16\n"));
        StringBuilder.append(addr(sb), str("    "));
        StringBuilder.append(addr(sb), temp_reg);
        StringBuilder.append(addr(sb), str(" =w loadw "));
        StringBuilder.append(addr(sb), addr_reg);
        StringBuilder.append(addr(sb), str("\n"));
    } elif equals_c(member_name, "data") {
        StringBuilder.append(addr(sb), str("    "));
        StringBuilder.append(addr(sb), temp_reg);
        StringBuilder.append(addr(sb), str(" =w loadw "));
        StringBuilder.append(addr(sb), object_reg);
        StringBuilder.append(addr(sb), str("\n"));
    } else {
        return expr;
    }
    
    return temp_reg;
}

/// Process the C function calls
def process_c_function_calls(expr: string): string {
    if contains_function_call(expr) and !str_contains(expr, str("C.")) {
        return resolve_member_access(expr);
    }
    
    mut result: string = resolve_member_access(expr);
    result = replace_all(result, str("C."), str("$"));
    result = replace_all(result, str("$("), str("call $("));
    return result;
}

/// Fix float literals that have spaces around the dot
def fix_float_literals(expr: string): string {
    mut result: string = replace_all(expr, str(" . "), str("."));
    result = strip(result); 
    result = resolve_member_access(result);
    
    if equals_c(result, "0.0") {
        result = str("s_0.0");
    } elif is_float_literal(result)
        and !has_prefix(result, str("s_"))
        and !has_prefix(result, str("d_")) {
        result = concat(str("s_"), result);
    }
    
    return result;
}

/// Check if a string is actually a float literal (not a function call or member access)
def is_float_literal(expr: string): bool {
    if !str_contains(expr, str(".")) {
        return false;
    }
    
    if str_contains(expr, str("(")) {
        return false;
    }
    
    mut i: i32 = 0;
    mut has_dot: bool = false;
    mut has_digit: bool = false;
    
    loop {
        if i >= str_len(expr) {
            break;
        }
        
        val c: char = get_char(expr, i);
        if c == '.' {
            if has_dot {
                return false;
            }
            has_dot = true;
        } elif c >= '0' and c <= '9' {
            has_digit = true;
        } elif c == '-' or c == '+' {
            // Allow signs
        } elif c == 'e' or c == 'E' {
            // Allow scientific notation
        } elif c >= 'a' and c <= 'z' or c >= 'A' and c <= 'Z' {
            return false;
        } elif c == ' ' {
            return false;
        }
        
        i++;
    }
    
    return has_dot and has_digit;
}

/// Check if an expression contains a function call
def contains_function_call(expr: string): bool {
    return str_contains(expr, str("(")) and str_contains(expr, str(")")) and !str_contains(expr, str("C."));
}

/// Render a function call expression and store result in a register
def render_function_call_expression(expr: string, result_reg: string): string {
    mut func_name: string = extract_function_name(expr);
    func_name = convert_to_qbe_function_name(func_name);
    mut result: string = concat(str("    "), result_reg);
    result = concat(result, str(" =w call $"));
    result = concat(result, func_name);
    result = concat(result, str("()\n"));
    
    return result;
}

/// Extract function name from expression (simplified)
def extract_function_name(expr: string): string {
    mut clean_expr: string = replace_all(expr, str(" "), str(""));
    clean_expr = replace_all(clean_expr, str("("), str(""));
    clean_expr = replace_all(clean_expr, str(")"), str(""));
    return clean_expr;
}

/// Convert function name to QBE format
def convert_to_qbe_function_name(func_name: string): string {
    mut result: string = replace_all(func_name, str("."), str("__"));
    result = replace_all(result, str(" "), str(""));
    
    if !str_contains(result, str("__")) {
        result = concat(str("std__io__"), result);
    }
    
    return result;
}

/// Render member access for QBE
def render_qbe_member_access(ast: ref ASTNode): string {
    val object_name: string = ast.data.member_access.object_name;
    val member_name: string = ast.data.member_access.member_name;
    
    if !StringStringMap.contains(addr(g_qbe_var_registers), object_name) {
        return str("");
    }
    
    val object_reg: string = StringStringMap.get(addr(g_qbe_var_registers), object_name);
    
    if equals_c(member_name, "len") {
        val temp_reg: string = next_qbe_register();
        val addr_reg: string = next_qbe_register();
        mut sb: StringBuilder = StringBuilder.init(256);
        
        StringBuilder.append(addr(sb), str("    "));
        StringBuilder.append(addr(sb), addr_reg);
        StringBuilder.append(addr(sb), str(" =l add "));
        StringBuilder.append(addr(sb), object_reg);
        StringBuilder.append(addr(sb), str(", 8\n"));
        StringBuilder.append(addr(sb), str("    "));
        StringBuilder.append(addr(sb), temp_reg);
        StringBuilder.append(addr(sb), str(" =w loadw "));
        StringBuilder.append(addr(sb), addr_reg);
        StringBuilder.append(addr(sb), str("\n"));
        
        return StringBuilder.to_string(addr(sb));
    } elif equals_c(member_name, "cap") {
        val temp_reg: string = next_qbe_register();
        val addr_reg: string = next_qbe_register();
        mut sb: StringBuilder = StringBuilder.init(256);
        
        StringBuilder.append(addr(sb), str("    "));
        StringBuilder.append(addr(sb), addr_reg);
        StringBuilder.append(addr(sb), str(" =l add "));
        StringBuilder.append(addr(sb), object_reg);
        StringBuilder.append(addr(sb), str(", 16\n"));
        StringBuilder.append(addr(sb), str("    "));
        StringBuilder.append(addr(sb), temp_reg);
        StringBuilder.append(addr(sb), str(" =w loadw "));
        StringBuilder.append(addr(sb), addr_reg);
        StringBuilder.append(addr(sb), str("\n"));
        
        return StringBuilder.to_string(addr(sb));
    } elif equals_c(member_name, "data") {
        val temp_reg: string = next_qbe_register();
        mut sb: StringBuilder = StringBuilder.init(256);
        
        StringBuilder.append(addr(sb), str("    "));
        StringBuilder.append(addr(sb), temp_reg);
        StringBuilder.append(addr(sb), str(" =w loadw "));
        StringBuilder.append(addr(sb), object_reg);
        StringBuilder.append(addr(sb), str("\n"));
        
        return StringBuilder.to_string(addr(sb));
    }
    
    return str("");
}

/// Render assignment for QBE
def render_qbe_assignment(ast: ref ASTNode): string {
    val variable: string = ast.data.assignment.variable;
    val expression: string = ast.data.assignment.expression;
    mut sb: StringBuilder = StringBuilder.init(128);
    
    if str_contains(variable, str(".")) {
        val dot_pos: i32 = find_substr(variable, str("."));
        if dot_pos > 0 {
            val object_name: string = substring_se(variable, 0, dot_pos);
            val member_name: string = substring_se(variable, dot_pos + 1, cast[i32](str_len(variable)));
            
            if StringStringMap.contains(addr(g_qbe_var_registers), object_name) {
                val object_reg: string = StringStringMap.get(addr(g_qbe_var_registers), object_name);
                mut processed_expr: string = process_c_function_calls(expression);

                processed_expr = fix_float_literals(processed_expr);
                
                mut offset: string = str("0");
                if equals_c(member_name, "data") {
                    offset = str("0");
                } elif equals_c(member_name, "len") {
                    offset = str("8");
                } elif equals_c(member_name, "cap") {
                    offset = str("16");
                }
                
                StringBuilder.append(addr(sb), str("    storew "));
                StringBuilder.append(addr(sb), processed_expr);
                StringBuilder.append(addr(sb), str(", "));
                StringBuilder.append(addr(sb), object_reg);
                StringBuilder.append(addr(sb), str(" + "));
                StringBuilder.append(addr(sb), offset);
                StringBuilder.append(addr(sb), str("\n"));
            }
        }
    } else {
        if StringStringMap.contains(addr(g_qbe_var_registers), variable) {
            val reg: string = StringStringMap.get(addr(g_qbe_var_registers), variable);
            
            mut processed_expr: string = process_c_function_calls(expression);
            processed_expr = fix_float_literals(processed_expr);
            
            StringBuilder.append(addr(sb), str("    storew "));
            StringBuilder.append(addr(sb), processed_expr);
            StringBuilder.append(addr(sb), str(", "));
            StringBuilder.append(addr(sb), reg);
            StringBuilder.append(addr(sb), str("\n"));
        }
    }
    
    return StringBuilder.to_string(addr(sb));
}

/// Render if statement for QBE
def render_qbe_if(ast: ref ASTNode): string {
    mut sb: StringBuilder = StringBuilder.init(256);
    
    val then_label: string = concat(str("then_"), i32_to_string(g_qbe_register_counter));
    val end_label: string = concat(str("end_"), i32_to_string(g_qbe_register_counter));
    g_qbe_register_counter++;
    
    val cond_reg: string = next_qbe_register();
    StringBuilder.append(addr(sb), str("    "));
    StringBuilder.append(addr(sb), cond_reg);
    StringBuilder.append(addr(sb), str(" =w ceqw 1, 1\n"));
    
    mut has_else: bool = false;
    if ast.children != nil {
        val children: ref list(ASTNode) = ast.children;
        val child_count: i32 = len(deref(children));
        if child_count > 1 {
            val else_code: string = render_qbe_ast_node(addr(children.data[1]));
            if str_len(strip(else_code)) > 0 {
                has_else = true;
            }
        }
    }
    
    if has_else {
        val else_label: string = concat(str("else_"), i32_to_string(g_qbe_register_counter - 1));
        StringBuilder.append(addr(sb), str("    jnz "));
        StringBuilder.append(addr(sb), cond_reg);
        StringBuilder.append(addr(sb), str(", @"));
        StringBuilder.append(addr(sb), then_label);
        StringBuilder.append(addr(sb), str(", @"));
        StringBuilder.append(addr(sb), else_label);
        StringBuilder.append(addr(sb), str("\n"));
        StringBuilder.append(addr(sb), str("@"));
        StringBuilder.append(addr(sb), then_label);
        StringBuilder.append(addr(sb), str("\n"));
        
        if ast.children != nil {
            val children: ref list(ASTNode) = ast.children;
            val child_count: i32 = len(deref(children));
            
            if child_count > 0 {
                val then_code: string = render_qbe_ast_node(addr(children.data[0]));
                StringBuilder.append(addr(sb), then_code);
            }
        }
        
        StringBuilder.append(addr(sb), str("    jmp @"));
        StringBuilder.append(addr(sb), end_label);
        StringBuilder.append(addr(sb), str("\n"));
        StringBuilder.append(addr(sb), str("@"));
        StringBuilder.append(addr(sb), else_label);
        StringBuilder.append(addr(sb), str("\n"));
        
        if ast.children != nil {
            val children: ref list(ASTNode) = ast.children;
            val child_count: i32 = len(deref(children));
            
            if child_count > 1 {
                val else_code: string = render_qbe_ast_node(addr(children.data[1]));
                StringBuilder.append(addr(sb), else_code);
            }
        }
        
        StringBuilder.append(addr(sb), str("@"));
        StringBuilder.append(addr(sb), end_label);
        StringBuilder.append(addr(sb), str("\n"));
    } else {
        val skip_label: string = concat(str("skip_"), i32_to_string(g_qbe_register_counter - 1));
        mut then_has_return: bool = false;

        if ast.children != nil {
            val children: ref list(ASTNode) = ast.children;
            val child_count: i32 = len(deref(children));
            
            if child_count > 0 {
                val then_code: string = render_qbe_ast_node(addr(children.data[0]));
                if str_contains(then_code, str("ret ")) {
                    then_has_return = true;
                }
            }
        }
        
        if then_has_return {
            val after_label: string = concat(str("after_"), i32_to_string(g_qbe_register_counter - 1));
            StringBuilder.append(addr(sb), str("    jnz "));
            StringBuilder.append(addr(sb), cond_reg);
            StringBuilder.append(addr(sb), str(", @"));
            StringBuilder.append(addr(sb), then_label);
            StringBuilder.append(addr(sb), str(", @"));
            StringBuilder.append(addr(sb), after_label);
            StringBuilder.append(addr(sb), str("\n"));
            StringBuilder.append(addr(sb), str("@"));
            StringBuilder.append(addr(sb), then_label);
            StringBuilder.append(addr(sb), str("\n"));
            
            if ast.children != nil {
                val children: ref list(ASTNode) = ast.children;
                val child_count: i32 = len(deref(children));
                
                if child_count > 0 {
                    val then_code: string = render_qbe_ast_node(addr(children.data[0]));
                    StringBuilder.append(addr(sb), then_code);
                }
            }
            
            StringBuilder.append(addr(sb), str("@"));
            StringBuilder.append(addr(sb), after_label);
            StringBuilder.append(addr(sb), str("\n"));
            StringBuilder.append(addr(sb), str("    ret 0\n"));
        } else {
            StringBuilder.append(addr(sb), str("    jnz "));
            StringBuilder.append(addr(sb), cond_reg);
            StringBuilder.append(addr(sb), str(", @"));
            StringBuilder.append(addr(sb), then_label);
            StringBuilder.append(addr(sb), str(", @"));
            StringBuilder.append(addr(sb), skip_label);
            StringBuilder.append(addr(sb), str("\n"));
            StringBuilder.append(addr(sb), str("@"));
            StringBuilder.append(addr(sb), then_label);
            StringBuilder.append(addr(sb), str("\n"));
            
            if ast.children != nil {
                val children: ref list(ASTNode) = ast.children;
                val child_count: i32 = len(deref(children));
                
                if child_count > 0 {
                    val then_code: string = render_qbe_ast_node(addr(children.data[0]));
                    StringBuilder.append(addr(sb), then_code);
                    
                    if !str_contains(then_code, str("ret ")) {
                        StringBuilder.append(addr(sb), str("@"));
                        StringBuilder.append(addr(sb), skip_label);
                        StringBuilder.append(addr(sb), str("\n"));
                    }
                }
            }
        }
    }
    
    return StringBuilder.to_string(addr(sb));
}

/// Render loop for QBE
def render_qbe_loop(ast: ref ASTNode): string {
    mut sb: StringBuilder = StringBuilder.init(256);
    
    val loop_label: string = concat(str("loop_"), i32_to_string(g_qbe_register_counter));
    g_qbe_register_counter++;
    
    StringBuilder.append(addr(sb), str("@"));
    StringBuilder.append(addr(sb), loop_label);
    StringBuilder.append(addr(sb), str("\n"));
    
    if ast.children != nil {
        val children: ref list(ASTNode) = ast.children;
        val child_count: i32 = len(deref(children));
        
        mut i: i32 = 0;
        loop {
            if i >= child_count {
                break;
            }
            val child_code: string = render_qbe_ast_node(addr(children.data[i]));
            StringBuilder.append(addr(sb), child_code);
            i++;
        }
    }
    
    StringBuilder.append(addr(sb), str("    jmp @"));
    StringBuilder.append(addr(sb), loop_label);
    StringBuilder.append(addr(sb), str("\n"));
    
    return StringBuilder.to_string(addr(sb));
}
